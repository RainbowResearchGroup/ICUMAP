# ICUMAP Visualisation Module

This module takes the layout produced by the t-SNE module and converts it into an interactive HTML5 visualisation.

## Setup

### 1. Install Dependencies
Dependencies were originally installed via bower, as this is the only dependency manager supported by Polymer 1.

However, because bower does not support shrink-wrapping, all dependencies ship with this project in the 
`bower_components` directory, so no further action is required.

### 2. Prepare Data Files
The visualisation module requires queries, data, and patient attributes files, all in JSON format.
All these files should be located in directory `src/t-sne-app/data/data-files`, or in a subdirectory of that.

#### a. Queries and Data
Provide two files, called queries.json and data.json, located in the same subdirectory of `src/../data-files`.
These files can be generated by the t-SNE module. See the README for that module for instructions on how to do so.

#### b. Patient Attributes File
If you extracted data using ICUMAP's MetaVision module, you should already have one of these.

Otherwise, you need to a produce a JSON file describing the time-invariant properties of interest for each patient. 
This must include outcome ("died"), but other attributes are optional. 
Examples of other attributes which might be of interest include 
length of stay, admission priority, surgery type, cause of death, age, sex etc.

Attributes must be provided in a JSON file in the following format:

```
[
    {
        "patientId": number, 
        "attributes": {
            "died": boolean,
            "attr1Name": attr1Value,
            ...,
            "attrNName": attrNValue
        } 
    },
    ...
]
```

Each patient must contain an attribute called "died". 
All other attributes are optional. Some patients may not have entries for some of the optional attributes - in such 
cases, exclude the key from the relevant patients' attributes dicts.

_Note: At this point, the sidebar, histograms, and cloud visualisation should all function.
You may wish to test these now by skipping ahead to the instructions for [Usage](#usage).
For instructions on how to configure record cards and filter options, continue with this section._

### 3. Implement Record Cards
Record cards provide brief summaries of the patients found to be most similar, and are presented along the bottom
edge of the interface.

By default, ICUMAP will display cards that show a similarity circle, outcome, length of stay, and Patient ID.
Outcome requires each patient to have a "died" attribute. Length of stay is computed from
"dischargeDate" and "admissionDate" attributes, which should both be numbers representing the milliseconds 
since a common reference date.

The default record card contains a blank space which may be populated with other site-specific data.

The source for similarity cards is available at ```src/t-sne-app/cards/patient-card.html```.

### 4. Add Custom Filter Rules (Optional)
By default, the filter drawer provides options for showing all patients, survivals only, deaths only, and contains
a code input for writing custom rules.

To change these filter options, or to provide new ones, create a JSON file in ```src/t-sne-app/data/data-files/``` 
in the following format:
```
[
    {
        "name": string,
        "apply": Patient -> boolean
    },
  ...
]
```
There is no need to specify a "Custom" case for enabling user-defined rules; this will be added automatically.

To use your customised set of filter rules, append ```filterRules=<custom-file-name>.json``` to the visualisation URL.
See [Run Options](#run-options) for more details.

## Usage
Run a static HTTP server in this directory.

For example, ```$ http-server -p 8081```. The visualisation is now available at [localhost:8081](http://localhost:8081).

ICUMAP is known to be compatible with Chrome 65 on Windows 10. Support for other browsers is not guaranteed.

**Important:** To get past the loading screen, you will need to specify the location of the data files.
Do this by setting the layout and attributes flags
e.g. ```localhost:8081?layout=tsne-output-directory&atttributes=attributes.json```.
For more details, refer to the next section, [Run Options](#run-options).

### Run Options
ICUMAP accepts multiple options for configuring its behaviour.
Options are set with query parameters in the URL i.e. options are set with a URL of the
form ```localhost:<port>?<option1>=<value1>&...&<optionN>=<valueN>```.

#### Full List of Options
| Option | Description |
|--------|-------------|
| layout | Path to the directory containing the queries.json and data.json files, relative to `src/t-sne-app/data/data-files/` 
| attributes | Path to the file containing the patient attributes, relative to `src/t-sne-app/data/data-files/`
| filterRules | Path to the file containing custom filter rules, relative to `src/t-sne-app/data/data-files/`
| similarity | Set to ```hidden``` to disable the "select patient for comparison" and "show the most similar historical patients" options.
| cloud | Set to ```hidden``` to hide the cloud.
| legend | Set to ```hidden``` to hide the admission/discharge/mortality choropleths.
| baseline | The minimum opacity each line in the cloud can be, from ```0``` (transparent) to ```1``` (opaque).
| lockable | Set to ```visible``` to enable the "Lock to this patient" option. When this checkbox is selected, the patient/time step selectors are restricted to prevent changing patient id or stepping forwards beyond the current time step. Useful for user studies.
| cardinalDistance | Distance to use between _all_ cardinal variables with different values when searching for the most similar patients.
| filter | Filter rule to initialise with e.g. ```?filter=p=>p.attributes["died"]===true```

TODO: layout and attributes currently default to Papworth. Delete these default settings.

#### Common configurations
When presenting ICUMAP functionality, it is often useful to introduce only the histograms at first, then to introduce
the trajectory of one patient, and finally to show all the trajectories. These different views can be created by
combining the above URL options as follows:

##### Show the sidebar only
```text
?cloud=hidden&legend=hidden
```

##### Show only one trajectory
This example will show only the trajectory for patient 1234 in the cloud. 
Setting the baseline to 1 prevents any individual line segments from fading, a behaviour which is unnecessary when
only showing one patient.
```text
?baseline=1&filter=p=>p.patientId===1234
```

##### Full ICUMAP
This requires no additional arguments beyond setting the layout directory and attributes file.
